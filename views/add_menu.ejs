<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lezzetli App | <%= mode==='edit' ? 'Edit' : 'Add' %> Menu</title>
  <link rel="stylesheet" href="/css/output.css">
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <!-- Add Choices.js CSS -->
  <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet">
</head>

<body class="bg-gray-50">
  <div class="flex h-screen overflow-hidden">
    <%- include('partials/sidebar') %>

      <div class="relative flex flex-col flex-1 overflow-x-hidden overflow-y-auto">
        <%- include('partials/header') %>

          <main class="flex-1 p-6">
            <div class="max-w-4xl mx-auto">
              <!-- Form Card -->
              <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                <!-- Header -->
                <div class="bg-gradient-to-r from-[#2B588D] to-[#5FA8A1] px-6 py-4">
                  <div class="flex items-center justify-between">
                    <div>
                      <h2 class="text-2xl font-bold text-white">
                        <%= mode==='edit' ? 'Edit Menu' : 'Add New Menu' %>
                      </h2>
                      <p class="text-white/90 text-sm mt-1">
                        <%= mode==='edit' ? 'Update menu details and items' : 'Create a new menu for your restaurant' %>
                      </p>
                    </div>
                    <div class="flex items-center space-x-2">
                      <span class="px-3 py-1 bg-white/20 rounded-full text-xs font-medium text-white">
                        <%= mode==='edit' ? 'Edit Mode' : 'Create Mode' %>
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Form Content -->
                <div class="p-6">
                  <form method="POST" action="<%= mode === 'edit' ? '/menus/edit/' + data.id : '/menus/add' %>">
                    <!-- Hidden ID Field -->
                    <% if (mode==='edit' ) { %>
                      <input type="hidden" name="id" value="<%= data.id || '' %>" />
                      <% } %>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                          <!-- Left Column -->
                          <div class="space-y-6">
                            <!-- Menu Type -->
                            <div>
                              <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Menu Type <span class="text-red-500">*</span>
                              </label>
                              <div class="grid grid-cols-2 gap-3">
                                <label
                                  class="flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors <%= data.type === 'daily' ? 'border-[#66BE6E] bg-green-50' : 'border-gray-300' %>">
                                  <input type="radio" name="type" value="daily" <%=!data.type || data.type==='daily'
                                    ? 'checked' : '' %> required
                                  class="h-4 w-4 text-[#66BE6E] focus:ring-[#66BE6E]">
                                  <div class="flex items-center space-x-2">
                                    <i class="fas fa-calendar-day text-[#66BE6E]"></i>
                                    <span class="font-medium">Daily</span>
                                  </div>
                                </label>
                                <label
                                  class="flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors <%= data.type === 'weekly' ? 'border-[#66BE6E] bg-green-50' : 'border-gray-300' %>">
                                  <input type="radio" name="type" value="weekly" <%=data.type==='weekly' ? 'checked'
                                    : '' %> required
                                  class="h-4 w-4 text-[#66BE6E] focus:ring-[#66BE6E]">
                                  <div class="flex items-center space-x-2">
                                    <i class="fas fa-calendar-week text-[#66BE6E]"></i>
                                    <span class="font-medium">Weekly</span>
                                  </div>
                                </label>
                              </div>
                            </div>

                            <!-- Meal Type -->
                            <div>
                              <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Meal Type <span class="text-red-500">*</span>
                              </label>
                              <div class="grid grid-cols-3 gap-3">
                                <label
                                  class="flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors <%= data.mealType === 'breakfast' ? 'border-[#66BE6E] bg-green-50' : 'border-gray-300' %>">
                                  <input type="radio" name="mealType" value="breakfast" <%=data.mealType==='breakfast'
                                    ? 'checked' : '' %> class="h-4 w-4 text-[#66BE6E] focus:ring-[#66BE6E]" required>
                                  <div class="flex items-center space-x-2">
                                    <i class="fas fa-sun text-yellow-500"></i>
                                    <span class="font-medium">Breakfast</span>
                                  </div>
                                </label>
                                <label
                                  class="flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors <%= !data.mealType || data.mealType === 'lunch' ? 'border-[#66BE6E] bg-green-50' : 'border-gray-300' %>">
                                  <input type="radio" name="mealType" value="lunch" <%=!data.mealType ||
                                    data.mealType==='lunch' ? 'checked' : '' %> required
                                  class="h-4 w-4 text-[#66BE6E] focus:ring-[#66BE6E]">
                                  <div class="flex items-center space-x-2">
                                    <i class="fas fa-sun text-orange-500"></i>
                                    <span class="font-medium">Lunch</span>
                                  </div>
                                </label>
                                <label
                                  class="flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors <%= data.mealType === 'dinner' ? 'border-[#66BE6E] bg-green-50' : 'border-gray-300' %>">
                                  <input type="radio" name="mealType" value="dinner" <%=data.mealType==='dinner'
                                    ? 'checked' : '' %> required
                                  class="h-4 w-4 text-[#66BE6E] focus:ring-[#66BE6E]">
                                  <div class="flex items-center space-x-2">
                                    <i class="fas fa-moon text-indigo-500"></i>
                                    <span class="font-medium">Dinner</span>
                                  </div>
                                </label>
                              </div>
                            </div>

                            <!-- Date Field - FIXED -->
                            <div>
                              <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Menu Date <span class="text-red-500">*</span>
                              </label>
                              <div class="relative">
                                <input type="text" name="date" id="dateInput" 
                                  value="<%= data.date || '' %>" 
                                  required placeholder="Select date"
                                  class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#66BE6E] focus:border-transparent transition-all duration-200">
                                <i
                                  class="fas fa-calendar absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                              </div>
                              <% if (mode==='edit' && data.date) { %>
                                <p class="text-xs text-gray-500 mt-1">
                                  Current date: <span class="font-medium"><%= data.date %></span>
                                </p>
                                <% } %>
                            </div>
                          </div>

                          <!-- Right Column -->
                          <div class="space-y-6">
                            <!-- Company ID (Optional) -->    
                            <% if (admin && admin.role==='admin' ) { %>
                              <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                  Company <% if (mode==='add' ) { %>(Optional)<% } %>
                                </label>

                                <% if (mode==='edit' ) { %>
                                  <!-- Edit Mode: Show selected company as disabled -->
                                  <% let selectedCompany=null; if (data.companyId && companies) {
                                    selectedCompany=companies.find(c=> c.id === data.companyId);
                                    }
                                    %>
                                    <div class="relative">
                                      <select name="companyId" disabled
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed">
                                        <% if (selectedCompany) { %>
                                          <option value="<%= selectedCompany.id %>" selected>
                                            <%= selectedCompany.name %> (<%= selectedCompany.company_code %>)
                                          </option>
                                          <% } else { %>
                                            <option value="" selected>No company assigned</option>
                                            <% } %>
                                      </select>
                                      <!-- Hidden input to submit the companyId -->
                                      <input type="hidden" name="companyId" value="<%= data.companyId || '' %>">
                                      <div class="absolute inset-0 bg-gray-100 opacity-0"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Company cannot be changed in edit mode</p>
                                    <% } else { %>
                                      <!-- Add Mode: Show dropdown with all companies -->
                                      <select name="companyId"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#66BE6E] focus:border-transparent transition-all duration-200">
                                        <option value="" <%=!data.companyId ? 'selected' : '' %>>Select Company
                                          (Optional)</option>
                                        <% if (companies && companies.length> 0) { %>
                                          <% companies.forEach(company=> { %>
                                            <option value="<%= company.id %>" <%=data.companyId===company.id
                                              ? 'selected' : '' %>>
                                              <%= company.name %> (<%= company.company_code %>)
                                            </option>
                                            <% }); %>
                                              <% } %>
                                      </select>
                                      <% } %>
                              </div>
                              <% } %>

                                <!-- Cutoff Time -->
                                <div>
                                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Cutoff Time
                                  </label>
                                  <div class="relative">
                                    <input type="time" name="cutoff_time" id="cutoffTimeInput"
                                      value="<%= data.cutoff_time || '' %>"
                                      class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#66BE6E] focus:border-transparent transition-all duration-200 bg-white">
                                    <i
                                      class="fas fa-clock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                  </div>
                                  <p class="text-xs text-gray-500 mt-1">Select menu date first to set cutoff time</p>
                                </div>

                                <!-- Active Status - FIXED -->
                                <div>
                                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Status
                                  </label>
                                  <label
                                    class="flex items-center space-x-3 p-4 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors <%= (data.is_active === true || data.is_active === 'true' || data.is_active === 1) ? 'border-[#66BE6E] bg-green-50' : 'border-gray-300' %>">
                                    <input type="checkbox" name="is_active" value="true" <%=(data.is_active == true ||
                                      data.is_active =='true' || data.is_active == 1) ? 'checked' : '' %>
                                    class="h-4 w-4 text-[#66BE6E] rounded focus:ring-[#66BE6E]">
                                    <div class="flex-1">
                                      <div class="font-medium text-gray-800">Active Menu</div>
                                      <div class="text-sm text-gray-500">Menu will be visible to customers</div>
                                    </div>
                                    <div
                                      class="px-2 py-1 text-xs font-medium rounded-full <%= (data.is_active == true || data.is_active == 'true' || data.is_active == 1) ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800' %>">
                                      <%= (data.is_active ==true || data.is_active =='true' || data.is_active ==1)
                                        ? 'Active' : 'Inactive' %>
                                    </div>
                                  </label>
                                </div>
                          </div>
                        </div>

                        <!-- Menu Items (Multi-select) -->
                        <div class="mt-6 pt-6 border-t border-gray-200">
                          <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Menu Items <span class="text-red-500">*</span>
                          </label>
                          <p class="text-sm text-gray-500 mb-4">Select items to include in this menu</p>

                          <!-- Hidden select for form submission -->
                          <select name="menu_items" multiple id="menuItemsHiddenSelect" class="hidden">
                            <% const selectedItems=data.menu_items || []; if (items && items.length> 0) {
                              items.forEach((item) => {
                              const isSelected = selectedItems.includes(item.id);
                              %>
                              <option value="<%= item.id %>" <%=isSelected ? 'selected' : '' %>></option>
                              <% }); } %>
                          </select>

                          <!-- Choices.js dropdown -->
                          <select id="menuItemsSelect" multiple placeholder="Select menu items...">
                            <% if (items && items.length> 0) { %>
                              <% items.forEach((item)=> {
                                const itemData = item.data ? item.data() : item;
                                %>
                                <option value="<%= item.id || itemData.id %>"
                                  data-name="<%= itemData.name || 'Unnamed Item' %>"
                                  data-price="<%= itemData.price || '0.00' %>" data-type="<%= itemData.type || '' %>"
                                  data-active="<%= itemData.is_active %>">
                                  <%= itemData.name || 'Unnamed Item' %> - $<%= itemData.price || '0.00' %>
                                      <% if (itemData.type==='veg' ) { %>
                                        (Veg)
                                        <% } else { %>
                                          (Non-Veg)
                                          <% } %>
                                            <% if (!itemData.is_active) { %>
                                              (Inactive)
                                              <% } %>
                                </option>
                                <% }); %>
                                  <% } else { %>
                                    <option value="" disabled>No menu items available</option>
                                    <% } %>
                          </select>

                          <div class="mt-3 text-sm text-gray-500">
                            <span id="selectedCount">0</span> items selected
                          </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="mt-8 pt-6 border-t border-gray-200 flex items-center justify-between">
                          <div>
                            <a href="/menus"
                              class="flex items-center space-x-2 text-gray-600 hover:text-gray-800 transition-colors duration-200">
                              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                              </svg>
                              <span class="font-medium">Back to Menus</span>
                            </a>
                          </div>
                          <div class="flex items-center space-x-4">
                            <button type="submit"
                              class="px-8 py-3 bg-gradient-to-r from-[#2B588D] to-[#5FA8A1]  text-white font-semibold rounded-lg hover:opacity-90 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                              <%= mode==='edit' ? 'Update Menu' : 'Create Menu' %>
                                <i class="fas fa-<%= mode === 'edit' ? 'save' : 'plus' %> ml-2"></i>
                            </button>
                          </div>
                        </div>
                  </form>
                </div>

                <!-- Form Footer Note -->
                <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                  <div class="flex items-center text-sm text-gray-500">
                    <i class="fas fa-info-circle text-[#66BE6E] mr-2"></i>
                    Fields marked with <span class="text-red-500">*</span> are required
                  </div>
                </div>
              </div>
            </div>
          </main>
      </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <!-- Data for JavaScript initialization -->
  <% if (mode==='edit' && data.date) { %>
    <script>
      // Set initial date for JavaScript
      const dateValue = "<%= data.date %>";
      if (dateValue && dateValue.trim() !== '') {
        window.initialDate = dateValue;
        console.log('Initial date set:', window.initialDate);
      }
    </script>
    <% } %>
      <% if (mode==='edit' && data.cutoff_time) { %>
        <script>
          // Set existing cutoff time
          const cutoffValue = "<%= data.cutoff_time %>";
          if (cutoffValue && cutoffValue.trim() !== '') {
            window.existingCutoffTime = cutoffValue;
          }
        </script>
        <% } %>

          <script>
            document.addEventListener('DOMContentLoaded', function () {
              let menuDate = null;
              let menuDatePicker = null;

              // Debug log
              console.log('DOM loaded, initialDate:', window.initialDate);
              console.log('Date input value:', document.getElementById('dateInput').value);

              // Date picker for menu date
              menuDatePicker = flatpickr("#dateInput", {
                dateFormat: "Y-m-d",
                minDate: "today",
                altInput: true,
                altFormat: "F j, Y",
                allowInput: true,
                onChange: function (selectedDates, dateStr, instance) {
                  menuDate = selectedDates[0];
                  console.log('Date selected:', menuDate);
                  updateCutoffTimePicker();
                }
              });

              // Initialize cutoff time picker
              const cutoffTimeInput = document.getElementById('cutoffTimeInput');
              if (cutoffTimeInput) {
                // Add event listener to validate menu date selection
                cutoffTimeInput.addEventListener('focus', function () {
                  if (!menuDate) {
                    alert("Please select menu date first");
                    cutoffTimeInput.blur();
                  }
                });
              }

              // Update cutoff time picker based on selected menu date
              function updateCutoffTimePicker() {
                const cutoffInput = document.getElementById('cutoffTimeInput');

                if (menuDate) {
                  // Enable the input
                  cutoffInput.disabled = false;
                  cutoffInput.classList.remove('bg-gray-100');
                  cutoffInput.classList.add('bg-white');

                  // If editing and cutoff_time exists, validate it matches the menu date
                  if (window.existingCutoffTime) {
                    // Check if the cutoff time string is in HH:MM format
                    const timePattern = /^\d{2}:\d{2}$/;
                    if (timePattern.test(window.existingCutoffTime)) {
                      // It's a time string, set it directly
                      cutoffInput.value = window.existingCutoffTime;
                    } else {
                      // Try to parse as date
                      try {
                        const existingCutoff = new Date(window.existingCutoffTime);
                        if (menuDate.toDateString() === existingCutoff.toDateString()) {
                          // Set the cutoff time if it matches the menu date
                          const timeString = existingCutoff.toTimeString().split(' ')[0].substring(0, 5);
                          cutoffInput.value = timeString;
                        } else {
                          // Clear cutoff time if it doesn't match the new menu date
                          cutoffInput.value = '';
                        }
                      } catch (e) {
                        // If parsing fails, just set the raw value if it's a valid time format
                        cutoffInput.value = window.existingCutoffTime;
                      }
                    }
                  }
                } else {
                  // Disable the input
                  cutoffInput.disabled = true;
                  cutoffInput.classList.add('bg-gray-100');
                  cutoffInput.classList.remove('bg-white');
                }
              }

              // Initialize Choices.js for menu items
              const choices = new Choices('#menuItemsSelect', {
                removeItemButton: true,
                searchEnabled: true,
                placeholderValue: 'Select menu items...',
                searchPlaceholderValue: 'Search items...',
                shouldSort: false,
                allowHTML: false
              });

              // Set initial selected items from hidden select
              const hiddenSelect = document.getElementById('menuItemsHiddenSelect');
              const selectedValues = Array.from(hiddenSelect.selectedOptions).map(opt => opt.value);

              if (selectedValues.length > 0) {
                choices.setChoiceByValue(selectedValues);
              }

              // Update count when selection changes
              choices.passedElement.element.addEventListener('change', function (e) {
                const selectedOptions = e.target.selectedOptions;
                const selectedCount = selectedOptions.length;

                // Update hidden select to match
                Array.from(hiddenSelect.options).forEach(option => {
                  option.selected = false;
                });

                Array.from(selectedOptions).forEach(option => {
                  const hiddenOption = hiddenSelect.querySelector(`option[value="${option.value}"]`);
                  if (hiddenOption) {
                    hiddenOption.selected = true;
                  }
                });

                updateSelectedCount(selectedCount);
              });

              // Initial count update
              updateSelectedCount(selectedValues.length);

              // Function to update selected count
              function updateSelectedCount(count) {
                document.getElementById('selectedCount').textContent = count;
              }

              // Initialize if in edit mode
              if (window.initialDate) {
                try {
                  console.log('Setting initial date:', window.initialDate);
                  // Set initial date and update cutoff time picker
                  const initialDate = new Date(window.initialDate);
                  if (!isNaN(initialDate.getTime())) {
                    menuDatePicker.setDate(initialDate);
                    menuDate = initialDate;
                    console.log('Date set successfully:', menuDate);
                    updateCutoffTimePicker();
                  } else {
                    console.warn('Invalid initial date:', window.initialDate);
                  }
                } catch (error) {
                  console.error('Error setting initial date:', error);
                }
              }
            });

            // Form submission handler to ensure required fields
            document.querySelector('form').addEventListener('submit', function (e) {
              const selectedItems = document.getElementById('menuItemsHiddenSelect').selectedOptions;

              // Validate required fields
              const menuType = document.querySelector('input[name="type"]:checked');
              const mealType = document.querySelector('input[name="mealType"]:checked');
              const dateInput = document.getElementById('dateInput');

              // Check if required fields are filled
              if (!menuType || !mealType || !dateInput.value.trim()) {
                e.preventDefault();
                alert('Please fill in all required fields: Menu Type, Meal Type, and Menu Date.');
                return false;
              }

              // Check if at least one menu item is selected
              if (selectedItems.length === 0) {
                e.preventDefault();
                alert('Please select at least one menu item.');
                return false;
              }

              // If cutoff time is set, validate it
              const cutoffTime = document.getElementById('cutoffTimeInput').value;
              if (cutoffTime && !menuDate) {
                e.preventDefault();
                alert('Please select a menu date before setting cutoff time.');
                return false;
              }
            });
          </script>
          <%- include('partials/script') %>
</body>

</html>