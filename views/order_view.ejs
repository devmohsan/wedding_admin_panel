<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lezzetli App | Order Details</title>
  <link rel="stylesheet" href="/css/output.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>

<body class="bg-gray-50">
  <div class="flex h-screen overflow-hidden">
    <%- include('partials/sidebar') %>

    <div class="relative flex flex-col flex-1 overflow-x-hidden overflow-y-auto">
      <%- include('partials/header') %>

      <main class="flex-1 p-6">
        <div class="max-w-4xl mx-auto">
          <!-- Back Button -->
          <div class="mb-6">
            <a href="/orders" class="inline-flex items-center text-gray-600 hover:text-gray-900 transition-colors duration-200">
              <i class="fas fa-arrow-left mr-2"></i>
              Back to Orders
            </a>
          </div>

          <!-- Header Card -->
          <div class="bg-gradient-to-r from-[#2B588D] to-[#5FA8A1] rounded-2xl shadow-lg mb-8 overflow-hidden">
            <div class="px-8 py-6">
              <div class="flex flex-col md:flex-row md:items-center justify-between">
                <div class="mb-4 md:mb-0">
                  <h2 class="text-3xl font-bold text-white mb-2">Order Details</h2>
                  <p class="text-white/90 text-sm">
                    Order ID: <%= order.id %>
                  </p>
                </div>
                <div class="flex items-center space-x-4">
                  <div class="bg-white/20 backdrop-blur-sm rounded-xl px-4 py-2">
                    <p class="text-sm text-white font-medium">
                      <i class="fas fa-receipt mr-2"></i>
                      Order #<%= order.id.slice(0, 8) %>...
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Main Content -->
          <div class="space-y-6">
            <!-- Order Summary Card -->
            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
              <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                  <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                  Order Summary
                </h3>
              </div>
              <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Order Information</h4>
                    <div class="space-y-3">
                      <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Order ID:</span>
                        <span class="text-sm font-medium text-gray-900"><%= order.id %></span>
                      </div>
                      <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Order Date:</span>
                        <span class="text-sm font-medium text-gray-900">
                          <%= order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleDateString() : 'N/A' %>
                          <%= order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleTimeString() : '' %>
                        </span>
                      </div>
                      <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Total Amount:</span>
                        <span class="text-lg font-bold text-[#2B588D]">$<%= order.total_amount || '0.00' %></span>
                      </div>
                    </div>
                  </div>
                  
                  <div>
                    <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Status Information</h4>
                    <div class="space-y-3">
                      <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Order Status:</span>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold
                          <%= order.status === 'completed' ? 'bg-emerald-100 text-emerald-800' : 
                             order.status === 'processing' ? 'bg-blue-100 text-blue-800' :
                             order.status === 'cancelled' ? 'bg-rose-100 text-rose-800' :
                             'bg-amber-100 text-amber-800' %>">
                          <div class="h-2 w-2 rounded-full mr-2 
                            <%= order.status === 'completed' ? 'bg-emerald-500' : 
                               order.status === 'processing' ? 'bg-blue-500' :
                               order.status === 'cancelled' ? 'bg-rose-500' :
                               'bg-amber-500' %>"></div>
                          <%= order.status || 'pending' %>
                        </span>
                      </div>
                      <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Payment Status:</span>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold
                          <%= order.payment_status === 'paid' ? 'bg-emerald-100 text-emerald-800' :
                             order.payment_status === 'failed' ? 'bg-rose-100 text-rose-800' :
                             'bg-amber-100 text-amber-800' %>">
                          <i class="<%= order.payment_status === 'paid' ? 'fas fa-check-circle' : 
                                    order.payment_status === 'failed' ? 'fas fa-times-circle' : 
                                    'fas fa-clock' %> mr-2 text-xs"></i>
                          <%= order.payment_status || 'pending' %>
                        </span>
                      </div>
                      <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Paid By:</span>
                        <span class="text-sm font-medium text-gray-900 capitalize">
                          <%= order.paid_by || 'N/A' %>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Customer & Company Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Customer Information -->
              <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100">
                  <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-user mr-2 text-purple-600"></i>
                    Customer Information
                  </h3>
                </div>
                <div class="p-6">
                  <% if (order.user) { %>
                    <div class="flex items-center space-x-4 mb-4">
                      <div class="h-12 w-12 rounded-full bg-gradient-to-r from-purple-100 to-purple-200 flex items-center justify-center text-purple-700 font-bold text-lg">
                        <%= order.user.name?.charAt(0).toUpperCase() || 'U' %>
                      </div>
                      <div>
                        <h4 class="text-lg font-semibold text-gray-900"><%= order.user.name || 'N/A' %></h4>
                        <p class="text-sm text-gray-600">Customer</p>
                      </div>
                    </div>
                    <div class="space-y-3">
                      <div class="flex items-center">
                        <i class="fas fa-envelope text-gray-400 mr-3 w-5"></i>
                        <span class="text-sm text-gray-900"><%= order.user.email || 'N/A' %></span>
                      </div>
                      <% if (order.user.phone) { %>
                        <div class="flex items-center">
                          <i class="fas fa-phone text-gray-400 mr-3 w-5"></i>
                          <span class="text-sm text-gray-900"><%= order.user.phone %></span>
                        </div>
                      <% } %>
                      <% if (order.user.companyName) { %>
                        <div class="flex items-center">
                          <i class="fas fa-building text-gray-400 mr-3 w-5"></i>
                          <span class="text-sm text-gray-900"><%= order.user.companyName %></span>
                        </div>
                      <% } %>
                    </div>
                  <% } else { %>
                    <p class="text-gray-500 text-center py-4">No customer information available</p>
                  <% } %>
                </div>
              </div>

              <!-- Company Information -->
              <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100">
                  <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-building mr-2 text-blue-600"></i>
                    Company Information
                  </h3>
                </div>
                <div class="p-6">
                  <% if (order.company) { %>
                    <div class="flex items-center space-x-4 mb-4">
                      <div class="h-12 w-12 rounded-lg bg-gradient-to-r from-blue-100 to-blue-200 flex items-center justify-center text-blue-700">
                        <i class="fas fa-building text-lg"></i>
                      </div>
                      <div>
                        <h4 class="text-lg font-semibold text-gray-900"><%= order.company.name || 'N/A' %></h4>
                        <p class="text-sm text-gray-600">Company</p>
                      </div>
                    </div>
                    <div class="space-y-3">
                      <% if (order.company.company_code) { %>
                        <div class="flex items-center">
                          <i class="fas fa-id-card text-gray-400 mr-3 w-5"></i>
                          <span class="text-sm text-gray-900"><%= order.company.company_code %></span>
                        </div>
                      <% } %>
                      <% if (order.company.email) { %>
                        <div class="flex items-center">
                          <i class="fas fa-envelope text-gray-400 mr-3 w-5"></i>
                          <span class="text-sm text-gray-900"><%= order.company.email %></span>
                        </div>
                      <% } %>
                      <% if (order.company.phone) { %>
                        <div class="flex items-center">
                          <i class="fas fa-phone text-gray-400 mr-3 w-5"></i>
                          <span class="text-sm text-gray-900"><%= order.company.phone %></span>
                        </div>
                      <% } %>
                    </div>
                  <% } else { %>
                    <p class="text-gray-500 text-center py-4">No company information available</p>
                  <% } %>
                </div>
              </div>
            </div>

            <!-- Menu Information -->
            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
              <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                  <i class="fas fa-utensils mr-2 text-emerald-600"></i>
                  Menu Information
                </h3>
              </div>
              <div class="p-6">
                <% if (order.menu) { %>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-3">
                      <div class="flex items-center">
                        <i class="fas fa-calendar text-gray-400 mr-3 w-5"></i>
                        <div>
                          <p class="text-xs text-gray-500">Menu Date</p>
                          <p class="text-sm font-medium text-gray-900">
                            <%= order.menu.date ? new Date(order.menu.date).toLocaleDateString() : 'N/A' %>
                          </p>
                        </div>
                      </div>
                      <div class="flex items-center">
                        <i class="fas fa-utensil-spoon text-gray-400 mr-3 w-5"></i>
                        <div>
                          <p class="text-xs text-gray-500">Meal Type</p>
                          <p class="text-sm font-medium text-gray-900 capitalize">
                            <%= order.menu.mealType || 'N/A' %>
                          </p>
                        </div>
                      </div>
                    </div>
                    <div class="space-y-3">
                      <div class="flex items-center">
                        <i class="fas fa-calendar-alt text-gray-400 mr-3 w-5"></i>
                        <div>
                          <p class="text-xs text-gray-500">Menu Type</p>
                          <p class="text-sm font-medium text-gray-900 capitalize">
                            <%= order.menu.type || 'N/A' %>
                          </p>
                        </div>
                      </div>
                      <% if (order.menu.cutoff_time) { %>
                        <div class="flex items-center">
                          <i class="fas fa-clock text-gray-400 mr-3 w-5"></i>
                          <div>
                            <p class="text-xs text-gray-500">Cutoff Time</p>
                            <p class="text-sm font-medium text-gray-900">
                              <%= order.menu.cutoff_time %>
                            </p>
                          </div>
                        </div>
                      <% } %>
                    </div>
                    <div class="space-y-3">
                      <div class="flex items-center">
                        <i class="fas fa-toggle-on text-gray-400 mr-3 w-5"></i>
                        <div>
                          <p class="text-xs text-gray-500">Menu Status</p>
                          <p class="text-sm font-medium text-gray-900">
                            <%= order.menu.is_active ? 'Active' : 'Inactive' %>
                          </p>
                        </div>
                      </div>
                      <% if (order.menu.companyId) { %>
                        <div class="flex items-center">
                          <i class="fas fa-link text-gray-400 mr-3 w-5"></i>
                          <div>
                            <p class="text-xs text-gray-500">Company ID</p>
                            <p class="text-sm font-medium text-gray-900 truncate">
                              <%= order.menu.companyId.slice(0, 8) %>...
                            </p>
                          </div>
                        </div>
                      <% } %>
                    </div>
                  </div>
                <% } else { %>
                  <p class="text-gray-500 text-center py-4">No menu information available</p>
                <% } %>
              </div>
            </div>

            <!-- Order Items -->
            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
              <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-list-ul mr-2 text-amber-600"></i>
                    Order Items (<%= order.items ? order.items.length : 0 %>)
                  </h3>
                  <div class="text-sm text-gray-600">
                    Subtotal: <span class="font-bold text-[#2B588D]">$<%= order.total_amount || '0.00' %></span>
                  </div>
                </div>
              </div>
              <div class="p-6">
                <% if (order.items && order.items.length > 0) { %>
                  <div class="overflow-hidden rounded-xl border border-gray-200">
                    <table class="w-full">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Item</th>
                          <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Type</th>
                          <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Quantity</th>
                          <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Price</th>
                          <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Total</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-200">
                        <% 
                          let subtotal = 0;
                          order.items.forEach(item => {
                            const itemTotal = (parseFloat(item.price || 0) * (item.quantity || 1)).toFixed(2);
                            subtotal += parseFloat(itemTotal);
                        %>
                        <tr class="hover:bg-gray-50">
                          <td class="px-6 py-4">
                            <div class="flex items-center">
                              <div class="h-10 w-10 flex-shrink-0 <%= item.type === 'veg' ? 'bg-green-50' : 'bg-red-50' %> rounded-lg flex items-center justify-center mr-3">
                                <div class="h-3 w-3 <%= item.type === 'veg' ? 'bg-green-500' : 'bg-red-500' %> rounded-full"></div>
                              </div>
                              <div>
                                <p class="text-sm font-medium text-gray-900"><%= item.name %></p>
                                <p class="text-xs text-gray-500">ID: <%= item.id.slice(0, 8) %>...</p>
                              </div>
                            </div>
                          </td>
                          <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                              <%= item.type === 'veg' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                              <%= item.type === 'veg' ? 'Vegetarian' : 'Non-Vegetarian' %>
                            </span>
                          </td>
                          <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">
                              <span class="font-medium"><%= item.quantity || 1 %></span> Ã—
                            </div>
                          </td>
                          <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">$<%= item.price || '0.00' %></div>
                          </td>
                          <td class="px-6 py-4">
                            <div class="text-sm font-semibold text-gray-900">$<%= itemTotal %></div>
                          </td>
                        </tr>
                        <% }); %>
                      </tbody>
                      <tfoot class="bg-gray-50">
                        <tr>
                          <td colspan="4" class="px-6 py-4 text-right text-sm font-semibold text-gray-700">
                            Subtotal:
                          </td>
                          <td class="px-6 py-4 text-sm font-bold text-gray-900">
                            $<%= subtotal.toFixed(2) %>
                          </td>
                        </tr>
                        <tr>
                          <td colspan="4" class="px-6 py-4 text-right text-sm font-semibold text-gray-700">
                            Total Amount:
                          </td>
                          <td class="px-6 py-4 text-lg font-bold text-[#2B588D]">
                            $<%= order.total_amount || subtotal.toFixed(2) %>
                          </td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                <% } else { %>
                  <p class="text-gray-500 text-center py-8">No items in this order</p>
                <% } %>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
              <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                  <i class="fas fa-cogs mr-2 text-indigo-600"></i>
                  Order Actions
                </h3>
              </div>
              <div class="p-6">
                <div class="flex flex-wrap gap-3">
                  <% if (order.status === 'pending') { %>
                    <button onclick="updateOrderStatus('<%= order.id %>', 'processing')"
                      class="inline-flex items-center px-5 py-3 bg-gradient-to-r from-blue-50 to-blue-100 text-blue-700 rounded-xl hover:from-blue-100 hover:to-blue-200 hover:text-blue-800 hover:shadow-md transition-all duration-200 transform hover:-translate-y-0.5 border border-blue-200">
                      <i class="fas fa-play mr-3"></i>
                      Start Processing Order
                    </button>
                  <% } %>
                  
                  <% if (order.status === 'processing') { %>
                    <button onclick="updateOrderStatus('<%= order.id %>', 'completed')"
                      class="inline-flex items-center px-5 py-3 bg-gradient-to-r from-emerald-50 to-emerald-100 text-emerald-700 rounded-xl hover:from-emerald-100 hover:to-emerald-200 hover:text-emerald-800 hover:shadow-md transition-all duration-200 transform hover:-translate-y-0.5 border border-emerald-200">
                      <i class="fas fa-check mr-3"></i>
                      Mark as Completed
                    </button>
                  <% } %>

                  <% if (order.payment_status === 'pending') { %>
                    <button onclick="markAsPaid('<%= order.id %>')"
                      class="inline-flex items-center px-5 py-3 bg-gradient-to-r from-purple-50 to-purple-100 text-purple-700 rounded-xl hover:from-purple-100 hover:to-purple-200 hover:text-purple-800 hover:shadow-md transition-all duration-200 transform hover:-translate-y-0.5 border border-purple-200">
                      <i class="fas fa-credit-card mr-3"></i>
                      Mark Payment as Paid
                    </button>
                  <% } %>

                  <a href="/orders"
                    class="inline-flex items-center px-5 py-3 bg-gradient-to-r from-gray-50 to-gray-100 text-gray-700 rounded-xl hover:from-gray-100 hover:to-gray-200 hover:text-gray-800 hover:shadow-md transition-all duration-200 transform hover:-translate-y-0.5 border border-gray-200">
                    <i class="fas fa-arrow-left mr-3"></i>
                    Back to Orders List
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // Update order status
    function updateOrderStatus(orderId, status) {
      Swal.fire({
        title: 'Update Order Status?',
        html: `Are you sure you want to mark this order as <strong>${status}</strong>?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#2B588D',
        cancelButtonColor: '#6b7280',
        confirmButtonText: `Yes, mark as ${status}`,
        cancelButtonText: 'Cancel',
        reverseButtons: true,
        customClass: {
          popup: 'rounded-2xl',
          confirmButton: 'px-6 py-2 rounded-lg font-semibold',
          cancelButton: 'px-6 py-2 rounded-lg font-semibold'
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = `/orders/status/${orderId}`;
          form.style.display = 'none';
          
          const statusField = document.createElement('input');
          statusField.type = 'hidden';
          statusField.name = 'status';
          statusField.value = status;
          form.appendChild(statusField);
          
          document.body.appendChild(form);
          form.submit();
        }
      });
    }
    
    // Mark as paid
    function markAsPaid(orderId) {
      Swal.fire({
        title: 'Mark as Paid?',
        html: 'Are you sure you want to mark this order as paid?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#66BE6E',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, mark as paid',
        cancelButtonText: 'Cancel',
        reverseButtons: true,
        customClass: {
          popup: 'rounded-2xl',
          confirmButton: 'px-6 py-2 rounded-lg font-semibold',
          cancelButton: 'px-6 py-2 rounded-lg font-semibold'
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = `/orders/payment/${orderId}`;
          form.style.display = 'none';
          
          const statusField = document.createElement('input');
          statusField.type = 'hidden';
          statusField.name = 'payment_status';
          statusField.value = 'paid';
          form.appendChild(statusField);
          
          document.body.appendChild(form);
          form.submit();
        }
      });
    }
  </script>

  <%- include('partials/script') %>
</body>

</html>